<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9">
    <title>Compress candlestick chart demo</title>
    <!--[if IE]>
    <script type="text/javascript" src="../excanvas.js"></script>
    <![endif]-->
    <script type="text/javascript" src="../dygraph-dev.js"></script>
    <script type="text/javascript" src="../extras/plotters.js"></script>

    <style type="text/css">
      body {
        max-width: 750px;
      }
      div.chart {
        width: 640px;
        height: 320px;
      }
    </style>
  </head>
  <body>
    <div id="candlechart" class=chart></div>
    <script type="text/javascript">
      Date.prototype.getWeek = function(){
        var d = new Date(+this);
        d.setHours(0,0,0);
        d.setDate(d.getDate()+4-(d.getDay()||7));
        return Math.ceil((((d-new Date(d.getFullYear(),0,1))/8.64e7)+1)/7);
      };
      Dygraph.DataHandlers.CompressHandler = function() {};
      var CompressHandler = Dygraph.DataHandlers.CompressHandler;
      CompressHandler.prototype = new Dygraph.DataHandlers.DefaultHandler();
      CompressHandler.prototype.seriesToPoints = function(series, setName, boundaryIdStart) {
        var compressRatios = [
          365,              // annually
          90,               // quarterly
          30,               // monthly
          7,                // weekly
          1,                // daily
          //1 / 24,           // hourly
          //1 / 24 / 60,      // minutely
          //1 / 24 / 60 / 6,  // 10 seconds
          //1 / 24 / 60 / 60  // 1 second
        ];
        var firstItem = series[0];
        var lastItem = series[series.length - 1];
        var dateDiff = lastItem[0] - firstItem[0];
        var dayMs = 1000 * 60 * 60 * 24;
        var compress = "days";
        var compressedSeries = [];
        var ratio = 1;
        var points = [];

        for (var i = 0; i < compressRatios.length; i++) {
          ratio = compressRatios[i] * dayMs;
          var bars = Math.round(dateDiff / ratio);
          if (bars < 50 && bars > 20) {
            break;
          }
        }

        for (var i = 0; i < series.length; i++) {
          var item = series[i];
          var diff = item[0] - firstItem[0];
          var idx = Math.floor(diff / ratio);
          if (compressedSeries[idx] === undefined) {
            compressedSeries[idx] = [];
          }
          compressedSeries[idx].push(item);
        }

        compressedSeries = compressedSeries.reduce(function(prev, curr) {
          var date = curr[curr.length - 1][0];
          var value;

          switch (setName.toLowerCase()) {
            case "open":
              value = curr[0][1]; // Open of the first day
            break;
            case "high":
              // Highest High of all the daily Highs
              value = Math.max.apply(null, curr.reduce(function(p, c) {
              p.push(c[1]);
              return p;
            }, []));
            break;
            case "low":
              // Lowest Low of all the daily Lows
              value = Math.min.apply(null, curr.reduce(function(p, c) {
              p.push(c[1]);
              return p;
            }, []));
            break;
            case "close":
              value = curr[curr.length - 1][1]; // Close of the last day
            break;
          }
          prev.push([date, value]);

          return prev;
        }, []);
        //compressedSeries = series;

        for (var i = 0; i < compressedSeries.length; ++i) {
          var item = compressedSeries[i];
          var yraw = item[1];
          var yval = yraw === null ? null : Dygraph.DataHandler.parseFloat(yraw);
          var point = {
            x : NaN,
            y : NaN,
            xval : Dygraph.DataHandler.parseFloat(item[0]),
            yval : yval,
            name : setName,
            idx : i + boundaryIdStart
          };
          points.push(point);
        }
        this.onPointsCreated_(compressedSeries, points);
        return points;
      }

      var candleData =
      "Date,Open,Close,High,Low\n";
      for (var i = 0; i <= 365 * 10; i++) {
        var d = new Date(i
                         * 1000 // ms
                         * 60   // sec
                         * 60   // min
                         * 24   // hr
                        );
        var dateStr = d.toISOString().match(/^\d{4}-\d{2}-\d{2}/)[0];
        var min = 100;
        var max = 400;
        var open = Math.random() * (max - min) + min;
        var close = Math.random() * (max - min) + min;
        var high = Math.max(open, close) * 1.25;
        var low = Math.min(open, close) * 0.75;

        candleData += [dateStr, open, close, high, low].join(",") + "\n";
      }
      g = new Dygraph(
        document.getElementById("candlechart"),
        candleData,
        {
          plotter: Dygraph.Plotters.candlePlotter,
          dataHandler: Dygraph.DataHandlers.CompressHandler
        }
      );
    </script>
  </body>
</html>
